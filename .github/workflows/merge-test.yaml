name: Merge test

on:
  workflow_dispatch: {}
  pull_request: {}
  push:
    branches:
      - main

jobs:
  test-energy-price-data-matrix:
    name: Test data matrix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: |
          mkdir ./empty-data-folder

      - name: Test non-existing file
        run: |
          set +e
          sh .github/scripts/energy-price-data-matrix.sh .non-existing-file.json ./data/ > /dev/null
          [ $? -eq 1 ] || exit 1

      - name: Test non-existing directory
        run: |
          set +e
          sh .github/scripts/energy-price-data-matrix.sh .config.json ./non-existing-directory/ > /dev/null
          [ $? -eq 2 ] || exit 1

      - name: Test with no existing data that matrix contains all items from the configuration
        run: |
          set -e
          sh .github/scripts/energy-price-data-matrix.sh .config.json ./empty-data-folder/ | jq -r '.' > result
          jq -r '.' .config.json > expected
          diff -q expected result || { echo "Unexpected difference:"; diff expected result; exit 1; }

      - name: Test with existing well-known data when it was fresh that matrix does not contain DK1 items from the configuration
        run: |
          set -e
          sh .github/scripts/energy-price-data-matrix.sh .config.json .github/resources/test/well-known/existing-energy-price-data-write-output/ 1654300800 | jq -rc '.' > result
          grep -vq DK1 result

      - name: Test with existing well-known data when it was a day old that matrix does contain DK1 items from the configuration
        run: |
          set -e
          sh .github/scripts/energy-price-data-matrix.sh .config.json .github/resources/test/well-known/existing-energy-price-data-write-output/ 1654387200 | jq -rc '.' > result
          grep -q DK1 result

  test-energy-price-data-write:
    name: Test data write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: |
          mkdir ./empty-data-folder
          echo '[]' > ./empty-data-file

      - name: Test non-existing file
        run: |
          set +e
          sh .github/scripts/energy-price-data-write.sh .non-existing-file.json ./empty-data-folder DK1 > /dev/null
          [ $? -eq 1 ] || exit 1

      - name: Test non-existing directory
        run: |
          set +e
          sh .github/scripts/energy-price-data-write.sh .github/resources/test/well-known/existing-energy-price-data-write-output/2022/06/01/DK1.json ./non-existing-directory/ DK1 > /dev/null
          [ $? -eq 2 ] || exit 1

      - name: Test when given no data that write outputs no files
        run: |
          set -e
          sh .github/scripts/energy-price-data-write.sh ./empty-data-file ./empty-data-folder DK1
          [ -z "$(ls -1qA ./empty-data-folder)" ] || { echo "Unexpected files/folders:"; find ./empty-data-folder; exit 1; }

      - name: Test with existing well-known data that write actually writes output files as expected
        run: |
          set -e
          mkdir ./test
          trap "rm -rf ./test" EXIT
          sh .github/scripts/energy-price-data-write.sh .github/resources/test/well-known/existing-energy-price-data-write-output/2022/06/01/DK1.json ./test DK1
          diff -rq ./test .github/resources/test/well-known/energy-price-data-write-generated-output || { echo "Unexpected difference:"; diff -r ./test .github/resources/test/well-known/energy-price-data-write-generated-output; exit 1; }

  test-energy-price-data-pull:
    name: Test data pull
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Test if endpoints does not answer pull will fail
        run: |
          set +e
          export PATH=.github/resources/test/mocks/:$PATH
          unset WGET_OVERRIDE

          sh .github/scripts/energy-price-data-pull.sh DK1 1654545600 http://localhost:8000/
          [ $? -ne 0 ] || exit 1

      - name: Test with existing well-known data that pull outputs as expected
        run: |
          set -e
          export PATH=.github/resources/test/mocks/:$PATH
          export WGET_OVERRIDE=.github/resources/test/well-known/endpoint-response/datastore_search

          sh .github/scripts/energy-price-data-pull.sh DK1 1654545600 http://localhost:8000/ > result
          diff -q .github/resources/test/well-known/energy-price-data-pull-generated-output.json result || { echo "Unexpected difference:"; diff .github/resources/test/well-known/energy-price-data-pull-generated-output.json result; exit 1; }

  test-energy-price-data-index:
    name: Test data index
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: |
          mkdir ./empty-data-folder

      - name: Test non-existing file
        run: |
          set +e
          sh .github/scripts/energy-price-data-index.sh .non-existing-file.json ./empty-data-folder > /dev/null
          [ $? -eq 1 ] || exit 1

      - name: Test non-existing directory
        run: |
          set +e
          sh .github/scripts/energy-price-data-index.sh .config.json ./non-existing-directory/ > /dev/null
          [ $? -eq 2 ] || exit 1

      - name: Test incorrect prefix
        run: |
          set +e
          sh .github/scripts/energy-price-data-index.sh .config.json ./empty-data-folder /prefix/ > /dev/null
          [ $? -eq 3 ] || exit 1

      - name: Test with no existing data that index outputs no data
        run: |
          set -e
          sh .github/scripts/energy-price-data-index.sh .config.json ./empty-data-folder/ | jq -r '.' > result
          echo '[]' > expected
          diff -q expected result || { echo "Unexpected difference:"; diff expected result; exit 1; }

      - name: Test with existing well-known data index outputs as expected
        run: |
          set -e
          sh .github/scripts/energy-price-data-index.sh .config.json .github/resources/test/well-known/existing-energy-price-data-write-output/ /data | jq -r '.' > result
          diff -q .github/resources/test/well-known/energy-price-data-index-generated-output.json result || { echo "Unexpected difference:"; diff .github/resources/test/well-known/energy-price-data-index-generated-output.json result; exit 1; }

  test-energy-price-data-graph:
    name: Test data graph
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: |
          mkdir ./empty-data-folder

      - name: Test non-existing file
        run: |
          set +e
          sh .github/scripts/energy-price-data-graph.sh .non-existing-file.json ./empty-data-folder > /dev/null
          [ $? -eq 1 ] || exit 1

      - name: Test non-existing directory
        run: |
          set +e
          sh .github/scripts/energy-price-data-graph.sh .config.json ./non-existing-directory/ > /dev/null
          [ $? -eq 2 ] || exit 1

      # - name: Test with no existing data that graph outputs no data
      #   run: |
      #     set -e
      #     sh .github/scripts/energy-price-data-graph.sh .config.json ./empty-data-folder/ | jq -r '.' > result
      #     echo '[]' > expected
      #     diff -q expected result || { echo "Unexpected difference:"; diff expected result; exit 1; }

      # - name: Test with existing data that graph outputs as expected
      #   run: |
      #     set -e
      #     sh .github/scripts/energy-price-data-graph.sh .config.json .github/resources/test/well-known/existing-energy-price-data-write-output/ > result
      #     echo '[]' > expected # TODO: fix
      #     diff -q expected result || { echo "Unexpected difference:"; diff expected result; exit 1; }