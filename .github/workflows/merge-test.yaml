name: Merge test

on:
  workflow_dispatch: {}
  pull_request: {}
  push:
    branches:
      - main

jobs:
  test-data-matrix:
    name: Test data matrix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: |
          mkdir ./empty-data-folder

      - name: Test non-existing file
        run: |
          set +e
          sh .github/scripts/data-matrix.sh .non-existing-file.json ./data/ > /dev/null
          [ $? -eq 1 ] || exit 1

      - name: Test non-existing directory
        run: |
          set +e
          sh .github/scripts/data-matrix.sh .config.json ./non-existing-directory/ > /dev/null
          [ $? -eq 2 ] || exit 1

      - name: Test with no existing data that matrix contains all items from the configuration
        run: |
          set -e
          sh .github/scripts/data-matrix.sh .config.json ./empty-data-folder/ | jq -r '.' > result
          jq -r '.' .config.json > expected
          cmp -s expected result || { echo "Unexpected difference:"; diff expected result; exit 1; }

      - name: Test with existing well-known data when it was fresh that matrix does not contain DK1 items from the configuration
        run: |
          set -e
          sh .github/scripts/data-matrix.sh .config.json .github/resources/test/well-known-data/ 1654300800 | jq -rc '.' > result
          set +e
          grep DK1 result
          [ $? -eq 0 ] && exit 1;

      - name: Test with existing well-known data when it was a day old that matrix does contain DK1 items from the configuration
        run: |
          set -e
          sh .github/scripts/data-matrix.sh .config.json .github/resources/test/well-known-data/ 1654387200 | jq -rc '.' > result
          grep DK1 result > /dev/null
