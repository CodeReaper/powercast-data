name: Merge test

on:
  workflow_dispatch: {}
  pull_request: {}
  push:
    branches:
      - main

jobs:
  test-data-matrix:
    name: Test data matrix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Test non-existing file
        run: |
          set +e
          sh .github/scripts/data-matrix.sh .non-existing-file.json ./data/ > /dev/null
          [ $? -eq 1 ] || exit 1

      - name: Test non-existing directory
        run: |
          set +e
          sh .github/scripts/data-matrix.sh .config.json ./non-existing-directory/ > /dev/null
          [ $? -eq 2 ] || exit 1

      - name: Test with no existing data that matrix contains all items from the configuration
        run: |
          set -e
          mkdir ./data
          sh .github/scripts/data-matrix.sh .config.json ./data/ > result
          cmp -s .config.json result || { echo "Unexpected difference:"; diff .config.json result; exit 1; }
