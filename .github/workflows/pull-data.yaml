name: Pull data

on:
  # TODO: after successful run on main, enable schedule
  # schedule:
  #   - cron: '5 12,13,14,15,18,21 * * *'
  workflow_dispatch: {}

jobs:
  update-energy-price-data:
    # if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    name: Update energy price data
    steps:
      - uses: actions/checkout@v3

      - uses: actions/checkout@v3
        with:
          ssh-key: ${{ secrets.POWERCASTDEPLOY }}
          ref: main
          path: gh-pages

      - shell: bash
        name: Checkout or create github pages branch
        working-directory: gh-pages
        run: git checkout gh-pages2 || git checkout -b gh-pages2 # TODO: after successful run on main, change to just: gh-pages

      - shell: bash
        name: Pull data
        run: |
          mkdir -p ./gh-pages/api/energy-price/ > /dev/null

          sh .github/scripts/energy-price-data-matrix.sh .config.json ./gh-pages/api/energy-price/ | jq -rc '.[]' | while read CONFIG; do
            ZONE=$(echo "$ITEM" | jq -r '.zone')
            ENDDATE=$(echo "$ITEM" | jq -r '.endDate')

            sh .github/scripts/energy-price-data-pull.sh $ZONE ${ENDDATE} > "${ZONE}.generated"
          done

      - shell: bash
        name: Write data
        run: |
          for GENERATED in *.generated; do
            ZONE=$(basename $GENERATED .generated)
            echo "Using generated data for ${ZONE}..."
            sh .github/scripts/energy-price-data-write.sh $GENERATED ./gh-pages/api/energy-price/ $ZONE
          done

      - shell: bash
        name: Index data
        run: |
          sh .github/scripts/energy-price-data-write.sh .config.json ./gh-pages/api/energy-price/ /api/energy-price > ./gh-pages/api/energy-price/latest.json

      - uses: EndBug/add-and-commit@v9
        name: Publish data
        with:
          cwd: gh-pages
          add: data
          push: true
          default_author: github_actions
          message: Update new data to GitHub pages via workflow
